<!doctype html>
<html>
    <head>
        <title>cosmovis</title>
        <link rel="stylesheet" href="/CosmoVis/style.css">

        <!-- load libraries -->
        
        <!-- <link src="styles/style.css" rel="stylesheet" type="text/css"> -->
        <!-- <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script> -->
        
        <link href="https://fonts.googleapis.com/css?family=Odibee+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.typekit.net/qnm2bha.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="/CosmoVis/libs/jQuery.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

        <script type="text/javascript" src="/CosmoVis/libs/dat.gui.min.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/d3.min.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/three.min.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/LineSegmentsGeometry.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/LineGeometry.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/LineMaterial.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/LineSegments2.js"></script>
        <script type="text/javascript" src="/CosmoVis/libs/Line2.js"></script>
        <script type="text/javascript" src="/CosmoVis/shaders/VolumeShader.js"></script>
        
        <script>
        $( function() {
            $( "#data_layers" ).draggable();
        } );
        $( function() {
            $( "#raySelection" ).draggable();
        } );
        // $( function() {
        //     $( "#my-gui-container" ).draggable();
        // } );
        $( function() {
            $( "#spectrum" ).draggable();
        } );
        $( function() {
            $( "#terminal" ).draggable();
        } );
        // $( function() {
        //     $( ".icon" ).draggable();
        // } );
        </script>
        
        
        <script type="x-shader/x-vertex" id="vertexshader-gas">
            
            uniform float zoom;
            uniform vec4 minCol;
            uniform vec4 maxCol;
            uniform float min;
            uniform float max;
            attribute float gasAttribute;
            
            varying float vZoom;
            varying vec4 vMinCol;
            varying vec4 vMaxCol;
            varying float vMin;
            varying float vMax;
            varying float vGasAttr;

            
            void main() {
                
                vGasAttr = gasAttribute;
                vZoom = zoom;
                vMinCol = minCol;
                vMaxCol = maxCol;
                vMin = min;
                vMax = max;
                vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                //gl_PointSize = zoom / (100.0);//* -mvPosition.z);
                gl_PointSize = 2.0;
                gl_Position = projectionMatrix * mvPosition;
                
            }
        
        </script>
        
        <script type="x-shader/x-fragment" id="fragmentshader-gas">
            
            uniform sampler2D texture;
            
            uniform bool minClip;
            uniform bool maxClip;
            varying float vZoom;
            varying float vGasAttr;
            varying vec4 vMinCol;
            varying vec4 vMaxCol;
            varying float vMin;
            varying float vMax;


            void main() {

                if(minClip){
                    if(vGasAttr < vMin){
                        discard;
                    }
                }
                if(maxClip){
                    if(vGasAttr > vMax){
                        discard;
                    }
                }

                //gl_FragColor = vec4(0.6,0.6,0.3,log(vZoom)/70.0));//* texture2D( texture, gl_PointCoord );
                //gl_FragColor = vec4(vGasAttr,vGasAttr,vGasAttr,log(vZoom)/70.0);//* texture2D( texture, gl_PointCoord ); 
                
                float alpha = ( vGasAttr - vMin ) / ( vMax - vMin ); 
                float r = (1.0 - alpha)*(vMinCol.r) + alpha*vMaxCol.r;
                float g = (1.0 - alpha)*(vMinCol.g) + alpha*vMaxCol.g;
                float b = (1.0 - alpha)*(vMinCol.b) + alpha*vMaxCol.b;
                gl_FragColor = vec4(r,g,b,1.0);

                //gl_FragColor = mix( vMinCol, vMaxCol, ( vGasAttr - vMin ) / ( vMax - vMin ) );

                //gl_FragColor.a *= 1.0/pow( gl_FragCoord.z, 2.0 );

                gl_FragColor.a = 1.0 ;    

                //if(vGasAttr<=vMin || vGasAttr>=vMax){
                //    gl_FragColor.a = 0.0 ;
                //}
                //else{
                //    gl_FragColor.a = 1.0 ;    
                //}
    
            }
        </script>

        <script type="x-shader/x-vertex" id="vertexshader-darkmatter">
            uniform vec4 Col;
            //uniform vec4 maxCol;
            attribute float dmAttribute;
            uniform float zoom;
            varying float vZoom;
            varying float vDMAttr;
            varying vec4 vCol;
            //varying vec4 vMaxCol;
            void main() {
                vZoom = zoom;
                vCol = Col;
                //vMaxCol = maxCol;
                vDMAttr = dmAttribute;
                vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                //gl_PointSize = zoom / 100.0; //( -mvPosition.z * 000.0 );
                gl_PointSize = 2.0;
                gl_Position = projectionMatrix * mvPosition;
                
            }
        </script>
        
        <script type="x-shader/x-fragment" id="fragmentshader-darkmatter">
            
            varying vec4 vCol;
            //varying vec4 vMaxCol;
            uniform sampler2D texture;
            varying float vZoom;
            varying float vDMAttr;
            void main() {

                //gl_FragColor = vec4(0.55,0.35,0.55,log(vZoom)/70.0);//* texture2D( texture, gl_PointCoord );
                //gl_FragColor = mix( vMinCol,vMaxCol,vDMAttr );
                gl_FragColor = vec4(vCol.r,vCol.g,vCol.b,1.0);//* texture2D( texture, gl_PointCoord ); 
                //gl_FragColor.a *= 1.0/pow( gl_FragCoord.z, 2.0 );
                //gl_FragColor.a *= pow( gl_FragCoord.z, 0.1 );
    
            }
        </script>

        <script type="x-shader/x-vertex" id="vertexshader-star">
            
            uniform vec4 Col;
            //uniform vec4 maxCol;
            varying vec4 vCol;
            //varying vec4 vMaxCol;
            uniform float zoom;
            attribute float starAttribute;
            varying float vStarAttribute;

            void main() {
                vCol = Col;
                //vMaxCol = maxCol;
                vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                vStarAttribute = starAttribute;
                //gl_PointSize = zoom / 100.0; //( -mvPosition.z * 000.0 );
                
                gl_PointSize = 1.0;
                gl_Position = projectionMatrix * mvPosition;
                
            }
        </script>
        
        <script type="x-shader/x-fragment" id="fragmentshader-star">
            
            uniform sampler2D texture;
            varying float vStarAttribute;
            varying vec4 vCol;
            //varying vec4 vMaxCol;
            void main() {

                //gl_FragColor = vec4(0.8*vStarAttribute,0.8*vStarAttribute,0.2*vStarAttribute,0.2);//* texture2D( texture, gl_PointCoord );
                //gl_FragColor = mix( vMinCol,vMaxCol,vStarAttribute );
                gl_FragColor = vec4(vCol.r,vCol.g,vCol.b,1.0);//* texture2D( texture, gl_PointCoord ); 
                //gl_FragColor.a *= 1.0/pow( gl_FragCoord.z, 2.0 );
                gl_FragColor.a *= pow( gl_FragCoord.z, 0.1 );
    
            }
        </script>

        <script type="x-shader/x-vertex" id="vertexshader-blackhole">
            uniform float zoom;
            attribute float bhAttribute;
            uniform float min;
            uniform float max;
            uniform vec4 minCol;
            uniform vec4 maxCol;
            
            varying vec4 vMinCol;
            varying vec4 vMaxCol;
            varying float vMin;
            varying float vMax;
            varying float vBHA;
            

            void main() {
                vBHA = bhAttribute;
                vMin = min;
                vMax = max;
                vMinCol = minCol;
                vMaxCol = maxCol;
                vec4 mvPosition = 4.0*modelViewMatrix * vec4( position, 1.0 );
                gl_PointSize = 4.0; //( -mvPosition.z * 000.0 );
                gl_Position = projectionMatrix * mvPosition;
                
            }
        </script>
        
        <script type="x-shader/x-fragment" id="fragmentshader-blackhole">
            
            //varying float vRotation;
            varying float vColor;
            varying float vBHA;
            uniform sampler2D texture;
            uniform bool minClip;
            uniform bool maxClip;
            varying vec4 vMinCol;
            varying vec4 vMaxCol;
            varying float vMin;
            varying float vMax;

            void main() {
                if(minClip){
                    if(vBHA < vMin){
                        discard;
                    }
                }
                if(maxClip){
                    if(vBHA > vMax){
                        discard;
                    }
                }

                float distanceFromCenter = length(2.0 * gl_PointCoord - 1.0);
                if(distanceFromCenter > 1.0){
                    discard;
                }

                //gl_FragColor = vec4(0.8*vBHA,0.2*vBHA,0.2*vBHA,1.0);//* texture2D( texture, gl_PointCoord );
                gl_FragColor = mix( vMinCol, vMaxCol, ( vBHA - vMin ) / ( vMax - vMin ) );
                //gl_FragColor = vec4(vColor,vColor,vColor,0.5);//* texture2D( texture, gl_PointCoord ); 
                //gl_FragColor.a *= 1.0/pow( gl_FragCoord.z, 2.0 );
                gl_FragColor.a *= pow( gl_FragCoord.z, 0.1 );
    
            }
        </script>

        <script type="x-shader/x-vertex" id="vertexshader-volume">
            
            void main() {
            
                
            }
        
        </script>
        
        <script type="x-shader/x-fragment" id="fragmentshader-volume">

            void main() {

                float a= tex3D(texCoord,dataTex);
                color = a * emissiveColor;
            }
        </script>
    
        <script type="x-shader/x-vertex" id="vertexshader-235">
            attribute float density;
            attribute float temperature;
            //uniform float spin;
            varying float vColor;
            //varying float vRotation;
            void main() {
                //vRotation = spin;
                vColor = temperature;
                vec4 mvPosition = modelViewMatrix * vec4( position.x, position.y, -temperature*8.47, 1.0 );
                gl_PointSize = 1.4;// * ( 300.0 / -mvPosition.z );
                gl_Position = projectionMatrix * mvPosition;
                
            }
        </script>
    
        <script type="x-shader/x-fragment" id="fragmentshader-235">
            
            //varying float vRotation;
            varying float vColor;
            uniform sampler2D texture;
            void main() {
    
                //float mid = 0.5;
                //vec2 rotated = vec2(cos(vRotation) * (gl_PointCoord.x - mid) + sin(vRotation) * (gl_PointCoord.y - mid) + mid,
                                    //cos(vRotation) * (gl_PointCoord.y - mid) - sin(vRotation) * (gl_PointCoord.x - mid) + mid);
                //vec4 rotatedTexture = texture2D( texture,  rotated);
                gl_FragColor = vec4(vColor,vColor,vColor,0.95);// * texture2D( texture, gl_PointCoord );
                //gl_FragColor.a *= 1/pow( gl_FragCoord.z, 2.0 );
    
            }
        </script>

        <script>
        // c holds the coordinate data
        // var c = new Array()

        var skewerData = []
        var domainLambda = []
        var xScale
        // var gasCoordLookup = []
        // var dmCoordLookup = []
        // var starCoordLookup = []
        // var bhCoordLookup = []

        
        $(document).ready(function(){
            
            

            // $('form#selectRay').submit(function(event) {
            //     var ray1 = [document.getElementById("ray_x1").value,document.getElementById("ray_y1").value,document.getElementById("ray_z1").value]
            //     var ray2 = [document.getElementById("ray_x2").value,document.getElementById("ray_y2").value,document.getElementById("ray_z2").value]
                
            //     socket.emit('selectRay', ray1,ray2);
                
            //     var geometry = new THREE.Geometry();
            //     geometry.vertices.push(new THREE.Vector3(ray1[0],ray1[1],ray1[2]) );
            //     geometry.vertices.push(new THREE.Vector3(ray2[0],ray2[1],ray2[2]) );

            //     var material = new THREE.LineBasicMaterial( { 
            //         color: 0xffff00,
            //         linewidth: 20

            //      } );

            //     var line = new THREE.Line( geometry, material );
            //     line.position.set(-(8.47)/2, -(8.47)/2,0)
            //     line.layers.set(4)
            //     scene.add( line );
            //     return false
            // });

            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            socket.on('field_list', function(msg) {
                if(!field_list){
                    field_list = msg.data
                    clearDropDowns()
                
                    createAttributeSelectors(field_list)
                    
                    function clearDropDowns(){
                        $("#gas_select").empty();
                        $("#dm_select").empty();
                        $("#star_select").empty();
                        $("#bh_select").empty();
                    }
                }

                // console.log(field_list);
                
                
                
                function createAttributeSelectors(field_list){
                    var select = document.getElementById("gas_select"); 
                    var option = document.createElement("option");
                    option.disabled = "disabled"
                    option.selected = "selected"
                    option.text = "Select an attribute"
                    select.add(option);

                    var select = document.getElementById("bh_select"); 
                    var option = document.createElement("option");
                    option.disabled = "disabled"
                    option.selected = "selected"
                    option.text = "Select an attribute"
                    select.add(option);

                    for(i = 0; i < field_list.length; i++){
                        if(field_list[i][0] == 'PartType0'){
                            var select = document.getElementById("gas_select"); 
                            var option = document.createElement("option");
                            option.text = field_list[i][1];
                            select.add(option);
                        }
                        // if(field_list[i][0] == 'PartType1'){
                        //     var select = document.getElementById("dm_select"); 
                        //     var option = document.createElement("option");
                        //     option.text = field_list[i][1];
                        //     select.add(option);
                        // }
                        // if(field_list[i][0] == 'PartType4'){
                        //     var select = document.getElementById("star_select"); 
                        //     var option = document.createElement("option");
                        //     option.text = field_list[i][1];
                        //     select.add(option);
                        // }
                        if(field_list[i][0] == 'PartType5'){
                            var select = document.getElementById("bh_select");
                            var option = document.createElement("option");
                            option.text = field_list[i][1];
                            select.add(option);
                        }
                    }
                }
            });

            socket.on('domain_edges', function(data){
                if(!edges){
                    console.log(data.left_edge);
                    edges = data
                    camera.position.set(edges.right_edge[0]-edges.left_edge[0], edges.right_edge[1]-edges.left_edge[1], edges.right_edge[2]-edges.left_edge[2])
                    controls.target.set( (edges.right_edge[0]-edges.left_edge[0])/2, (edges.right_edge[1]-edges.left_edge[1])/2, (edges.right_edge[2]-edges.left_edge[2])/2 );

                    var geometry = new THREE.BoxBufferGeometry( data.right_edge[0]-data.left_edge[0], data.right_edge[1]-data.left_edge[1], data.right_edge[2]-data.left_edge[2] );
                    var material = new THREE.MeshBasicMaterial( {color: 0x000000, wireframe: true, transparent: true, opacity: 0.0} );
                    cube = new THREE.Mesh( geometry, material );
                    cube.position.set((edges.right_edge[0]-edges.left_edge[0])/2, (edges.right_edge[1]-edges.left_edge[1])/2, (edges.right_edge[2]-edges.left_edge[2])/2)
                    // scene.add( cube );
                }
                
            });

            socket.on('my_response', function(msg, cb) {
                console.log('Received #' + msg.count + ': ' + msg.data);
                if (cb)
                    cb();
            });

            socket.on('positionData',function(msg){
                ptype = msg.particle_type
                if(ptype == 'PartType0'){
                    gasCoordLookup.push(msg.data)
                    let gas = document.getElementById("gas_progress")
                    gas.value = msg.i
                    if(msg.i == 100){plotPoints()}
                }
                if(ptype == 'PartType1'){
                    dmCoordLookup.push(msg.data)
                    let dm = document.getElementById("dm_progress")
                    dm.value = msg.i
                    if(msg.i == 100){plotPoints()}
                }
                if(ptype == 'PartType4'){
                    starCoordLookup.push(msg.data)
                    starParticles.push(msg)
                    let star = document.getElementById("star_progress")
                    star.value = msg.i*10
                }
                if(ptype == 'PartType5'){
                    bhCoordLookup.push(msg.data)
                    let bh = document.getElementById("bh_progress")
                    bh.value = msg.i*10
                }

            });

            socket.on('dataSentMsg',function(msg){
                if(msg.particle_type == "PartType0"){
                    let gas = document.getElementById("gas_progress_sent")
                    gas.value = (msg.value/renderCount)*100
                }
                if(msg.particle_type == "PartType5"){
                    let bh = document.getElementById("bh_progress_sent")
                    bh.value = (msg.value/renderCount)*100
                }
            });

            socket.on('pointData',function(msg) {
                console.log(msg);
                // let found = field_list.find(element => element[0] == msg.particle_type && element[1] == msg.attribute)
                // let index = field_list.indexOf(found)
                // if(field_list[index].length == 2){
                //     field_list[index].push(data=[])
                // }

                // field_list[index][2].push([msg.data])
                particles.push(msg)

                if(msg.particle_type == "PartType0"){
                    gasParticles.push(msg)
                    let gas = document.getElementById("gas_progress")
                    gas.value = (msg.i/renderCount)*100
                    // if(msg.i+1 == renderCount){
                    col = document.getElementById('gas-minval-input')
                    col.value=msg.min
                    materialGas.uniforms.min.value = msg.min
                    col = document.getElementById('gas-maxval-input')
                    col.value=msg.max
                    materialGas.uniforms.max.value = msg.max
                    // }
                }
                if(msg.particle_type == "PartType1"){
                    dmParticles.push(msg)
                    let dm = document.getElementById("dm_progress")
                    dm.value = msg.i*renderCount
                }
                if(msg.particle_type == "PartType4"){
                    starParticles.push(msg)
                    let star = document.getElementById("star_progress")
                    star.value = msg.i*renderCount
                }
                if(msg.particle_type == "PartType5"){
                    bhParticles.push(msg)
                    let bh = document.getElementById("bh_progress")
                    bh.value = (msg.i/renderCount)*100
                    // if(msg.i == 10){
                    col = document.getElementById('bh-minval-input')
                    col.value=msg.min
                    materialGas.uniforms.min.value = msg.min
                    col = document.getElementById('bh-maxval-input')
                    col.value=msg.max
                    materialBlackHole.uniforms.max.value = msg.max
                    // }
                }
                updateUnits(msg.particle_type, msg.units)
                
                if(msg.i >= renderCount){
                    plotPoints()
                }
            });

            socket.on('processingRay',function(msg){
                idx = msg.index
                buttonId = 'request-button-' + idx + ''
                div = document.getElementById(buttonId)
                div.innerText = 'generating spectrum . . . '
            });

            socket.on('sentRay',function(msg){
                idx = msg.index
                buttonId = 'request-button-' + idx + ''
                div = document.getElementById(buttonId)
                div.innerText = 'sending spectrum . . . '
            });

            socket.on('synthetic_spectrum', function(msg) {
                console.log(msg)
                idx = msg.index
                buttonId = 'request-button-' + idx + ''
                div = document.getElementById(buttonId)
                if(div){
                    div.innerText = 'spectrum received!' 
                }
                plotSyntheticSpectrum(msg);
            });
            
            // socket.on('dataC', function(msg) {
            //     // c.push(msg.data)
            //     plotPoint(msg.data)
            //     // $('#log').append('<br>' + $('<div/>').text('Received ' + msg.data).html());
            // });

            // var ping_pong_times = [];
            // var start_time;
            
            // window.setInterval(function() {
            //     start_time = (new Date).getTime();
            //     socket.emit('my_ping');
            // }, 1000);
            
            // socket.on('my_pong', function() {
            //     var latency = (new Date).getTime() - start_time;
            //     ping_pong_times.push(latency);
            //     ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
            //     var sum = 0;
            //     for (var i = 0; i < ping_pong_times.length; i++)
            //         sum += ping_pong_times[i];
            //     $('#ping-pong').text(Math.round(10 * sum / ping_pong_times.length) / 10);
            // });

            // $('form#disconnect').submit(function(event) {
            //     socket.emit('disconnect_request');
            //     return false;
            // });
            // $('form#loadData').submit(function(event) {
            //     socket.emit('loadData');
            //     return false;
            // });
            // $('form#sendCoords').submit(function(event) {
            //     socket.emit('sendCoords');
            //     return false;
            // });

        });

        </script>
    </head>
    <body>
   
        <!-- load scripts -->
    <script type="text/javascript" src="libs/Tween.js"></script>
    <script type="text/javascript" src="libs/OrbitControls.js"></script>
    <script type="text/javascript" src="js/cosmo-vis.js"></script>
    <script>

        function toggleLayer( l ){
            
            if(l==0){
                if(!gasMesh){
                    loadAttribute(gridsize,'PartType0','Temperature',false)
                    visible = true
                }
                else{
                    visible = !gasMesh.layers.test( camera.layers );
                    camera.layers.toggle( l )
                }
                if(visible){
                    var x = document.getElementById("gas-eye-open");
                    x.style.display = "inline-block";

                    var y = document.getElementById("gas-eye-closed");
                    y.style.display = "none";

                }
                else{
                    var x = document.getElementById("gas-eye-open");
                    x.style.display = "none";
                    var y = document.getElementById("gas-eye-closed");
                    y.style.display = "inline-block";

                }
            }
            if(l==1){
                if(!dmMesh){
                    loadAttribute(gridsize,'PartType1','density',false)
                    visible = true
                }
                else{
                    visible = !dmMesh.layers.test( camera.layers )
                    camera.layers.toggle( l )
                }
                if(visible){
                    var x = document.getElementById("dm-eye-open");
                    x.style.display = "inline-block";

                    var y = document.getElementById("dm-eye-closed");
                    y.style.display = "none";

                }
                else{
                    var x = document.getElementById("dm-eye-open");
                    x.style.display = "none";
                    var y = document.getElementById("dm-eye-closed");
                    y.style.display = "inline-block";
                }
            }
            if(l==2){
                if(!starMesh){
                    loadAttribute(gridsize,'PartType4','density',false)
                    visible = true
                }
                else{
                    var visible = !starMesh.layers.test( camera.layers );
                    camera.layers.toggle( l )
                }
                if(visible){
                    var x = document.getElementById("star-eye-open");
                    x.style.display = "inline-block";

                    var y = document.getElementById("star-eye-closed");
                    y.style.display = "none";

                }
                else{
                    var x = document.getElementById("star-eye-open");
                    x.style.display = "none";
                    var y = document.getElementById("star-eye-closed");
                    y.style.display = "inline-block";

                }
            }
            if(l==3){
                var visible = !bhMesh.layers.test( camera.layers );
                if(visible){
                    var x = document.getElementById("bh-eye-open");
                    x.style.display = "inline-block";

                    var y = document.getElementById("bh-eye-closed");
                    y.style.display = "none";

                }
                else{
                    var x = document.getElementById("bh-eye-open");
                    x.style.display = "none";
                    var y = document.getElementById("bh-eye-closed");
                    y.style.display = "inline-block";

                }
            }
            if(l==4){
                var visible = line.layers.test( camera.layers );
                if(visible){
                    var x = document.getElementById("skewer-eye-open");
                    x.style.display = "inline-block";

                    var y = document.getElementById("skewer-eye-closed");
                    y.style.display = "none";

                }
                else{
                    var x = document.getElementById("skewer-eye-open");
                    x.style.display = "none";
                    var y = document.getElementById("skewer-eye-closed");
                    y.style.display = "inline-block";

                }
            }
        }
        function requestPoints(size,type,attr){
            if(attr != 'Select an attribute'){
                loadAttribute(gridsize,type,attr)
            }
        }
        // function requestPoints(type,attr,renderCount){
        //     if(attr != 'Select an attribute'){

                
        //         exist = false
        //         for(i=0;i<particles.length;i++){

        //             if(particles[i].particle_type == type && particles[i].attribute == attr && particles[i].i >= renderCount){
        //                 exist = true
        //             }
        //         }

        //         if(!exist){
        //             socket.emit('requestPoints',type, attr,renderCount)
        //         }

        //         else{
        //             let min, max
        //             for(i=0;i<particles.length;i++){
        //                 if(particles[i].particle_type == type && particles[i].attribute == attr){
        //                     min = particles[i].min
        //                     max = particles[i].max
        //                 }
        //             }
        //             if(type == 'PartType0'){
        //                 col = document.getElementById('gas-minval-input')
        //                 col.value=min
        //                 materialGas.uniforms.min.value = min
        //                 col = document.getElementById('gas-maxval-input')
        //                 col.value=max
        //                 materialGas.uniforms.max.value = max
        //             }
        //             if (type == 'PartType5'){
        //                 col = document.getElementById('bh-minval-input')
        //                 col.value=min
        //                 materialGas.uniforms.min.value = min
        //                 col = document.getElementById('bh-maxval-input')
        //                 col.value=max
        //                 materialBlackHole.uniforms.max.value = max
        //             }
        //             plotPoints()
        //         }
        //     }
        // }
        
        function data_layers(){ 
            var x = document.getElementById("data_layers");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }    
        }
        
        function ray(){ 
            var x = document.getElementById("raySelection");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }    
        }

        function graph(){
            var x = document.getElementById("spectrum");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }    
        }

        function gui(){
            var x = document.getElementById("my-gui-container");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }    
        }
        function terminal(){
            var x = document.getElementById("terminal");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
            }
        }
        
        function hideDetails(type){
            var x = document.getElementById(type+"-data-details")
            // console.log(x)
            if(x.style.display === "none"){
                x.style.display = "block"
            }
            else x.style.display = "none"
        }
        $
    </script>
    <!-- <script type="text/javascript" src="libs/Tween.js"></script>
    <script type="text/javascript" src="libs/OrbitControls.js"></script>
    <script type="text/javascript" src="js/cosmo-vis.js"></script> -->
        <!-- <h1>Flask-SocketIO Test</h1>
    <p>Async mode is: <b>{{ async_mode }}</b></p>
    <p>Average ping/pong latency: <b><span id="ping-pong"></span>ms</b></p>
    <h2>Send:</h2>
     -->
    <!-- <form id="disconnect" method="POST" action="#">
        <input type="submit" value="Disconnect">
    </form>
    
    <form id="loadData" method="POST" action="#">
            <input type="submit" value="loadData">
    </form>
    
    <form id="sendCoords" method="POST" action="#">
            <input type="submit" value="sendCoords">
    </form> -->

    <div class="title">cosmovis</div>
    
    <div id="icon_container">
        
        <div id="data_layers_icon" class="icon_caption"><img 
            class="icon"
            src="/CosmoVis/assets/layers.svg" 
            alt="attributes and data filtering"
            role="button"
            onclick="data_layers()"/>layers</div>
        <div id="ray" class="icon_caption"><img 
            class="icon"
            src="/CosmoVis/assets/hst.svg" 
            alt="make an observation"
            role="button"
            onclick="ray()"/>observe</div>
        <div id="graph" class="icon_caption"><img 
            class="icon"
            src="/CosmoVis/assets/graph.svg" 
            alt="view spectrum"
            role="button"
            onclick="graph()"/>plot</div>
        
        <div id="terminal_icon" class="icon_caption"><img 
            class="icon"
            src="/CosmoVis/assets/terminal.svg" 
            alt="terminal event log"
            role="button"
            onclick="terminal()"/>details</div>

        <!-- <div id="morePoints" class="pointLevels">
            +
        </div>
        <div id="lessPoints" class="pointLevels">
            -
        </div> -->
        
    </div>
    <div id="containers">    
        <div id="data_layers" class="container">
            <!-- <h2>attribute visualization</h2>
            <br> -->
            <hr>
            
            <label for="gas_select"><h3><img 
                id="gas-eye-open"
                class="eye-icon"
                src="/CosmoVis/assets/eye_open.svg" 
                alt="gas visible"
                role="button"
                onclick="toggleLayer( 0 )"/>

            <img 
                id="gas-eye-closed"
                class="eye-icon"
                src="/CosmoVis/assets/eye_closed.svg" 
                alt="gas hidden"
                role="button"
                onclick="toggleLayer( 0 )"/>
            <img 
                id="gas-blend"
                class="blend-icon"
                src="/CosmoVis/assets/blend.svg" 
                alt="blend mode"
                role="button"
                onclick="toggleBlendMode( 0 )"/><div style="display: inline;" onclick="hideDetails('gas')">gas</div></h3></label>
            <br>
            <div id="gas-data-details" class="data-details">
                <div id="min">
                    min: <input type="checkbox" id="gas-min-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="gas-min-clip-check" onclick="updateUniforms()" checked> 
                    <br>
                    <input type="number" step="0.1" id="gas-minval-input" class="number-input minvalinput" name="gas-minval"><p class="units gas-attr-units"></p>

                    <!-- <input type="number" id="gas-minval-input" class="number-input minvalinput" name="gas-minval" oninput="changeValue('gas','min')"><p class="units gas-attr-units"></p> -->
                </div>
                <div id="max">
                    max: <input type="checkbox" id="gas-max-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="gas-max-clip-check" onclick="updateUniforms()" checked>
                    <br>
                    <!-- <input type="number" id="gas-maxval-input" class="number-input maxvalinput" name="gas-maxval" oninput="changeValue('gas','max')"><p class="units gas-attr-units"></p> -->
                    <input type="number" step="0.1" id="gas-maxval-input" class="number-input maxvalinput" name="gas-maxval"><p class="units gas-attr-units"></p>
                </div>
                
                <div id=gas-colorscale>
                    <input type="color" class="color-picker" value="#0000ff" id="gasMinCol"><input type="color" class="color-picker"  value="#ff0000" id="gasMaxCol">
                    <br>
                </div> 

                <br>
                <select class="data_select" id="gas_select" onchange="requestPoints(gridsize,'PartType0', document.getElementById('gas_select').value)">
                    <option selected="selected" disabled="disabled">Select an attribute</option></select>
                
                <!-- sent data : <progress id="gas_progress_sent" value="0" max="100"><p>loading</p> </progress>
                received data : <progress id="gas_progress" value="0" max="100"><p>loading</p> </progress> -->
            </div>
            <hr>
            <!-- <br> -->
            
            
            <label for="dm_select"><h3><img 
                id="dm-eye-open"
                class="eye-icon"
                src="/CosmoVis/assets/eye_open.svg" 
                alt="dark matter visible"
                role="button"
                onclick="toggleLayer( 1 )"/>
            <img 
                id="dm-eye-closed"
                class="eye-icon"
                src="/CosmoVis/assets/eye_closed.svg" 
                alt="dark matter hidden"
                role="button"
                onclick="toggleLayer( 1 )"/><img 
                id="gas-blend"
                class="blend-icon"
                src="/CosmoVis/assets/blend.svg" 
                alt="blend mode"
                role="button"
                onclick="toggleBlendMode( 1 )"/><div style="display: inline;" onclick="hideDetails('dm')">dark matter</div></h3></label>
            
            <br>
            <div id="dm-data-details" class="data-details">
        
                <div id="min">
                    min: <input type="checkbox" id="dm-min-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="dm-min-clip-check" onclick="updateUniforms()" checked> 
                    <br>
                    <input type="number" step="0.1" id="dm-minval-input" class="number-input minvalinput" name="dm-minval"><p class="units dm-attr-units"></p>

                </div>
                <div id="max">
                    max: <input type="checkbox" id="dm-max-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="dm-max-clip-check" onclick="updateUniforms()" checked>
                    <br>
                    <input type="number" step="0.1" id="dm-maxval-input" class="number-input maxvalinput" name="dm-maxval"><p class="units dm-attr-units"></p>
                </div>
                
                <div id=dm-colorscale>
                    <input type="color" class="color-picker" value="#0000ff" id="dmMinCol"><input type="color" class="color-picker"  value="#ff0000" id="dmMaxCol">
                    <br>
                </div> 
                <br>
            </div>
            <hr>
            <!-- <br> -->


            <label for="star_select"><h3><img 
                id="star-eye-open"
                class="eye-icon"
                src="/CosmoVis/assets/eye_open.svg" 
                alt="stars visible"
                role="button"
                onclick="toggleLayer( 2 )"/>
            <img 
                id="star-eye-closed"
                class="eye-icon"
                src="/CosmoVis/assets/eye_closed.svg" 
                alt="stars hidden"
                role="button"
                onclick="toggleLayer( 2 )"/><img 
                id="gas-blend"
                class="blend-icon"
                src="/CosmoVis/assets/blend.svg" 
                alt="blend mode"
                role="button"
                onclick="toggleBlendMode( 4 )"/><div style="display: inline;" onclick="hideDetails('star')">stars</div></h3></label>
                <br>
                <!-- <input type="color" class="color-picker" value="#ffffff" id="starCol"> -->
                <div id="star-data-details"class="data-details">
                    <div id="min">
                        min: <input type="checkbox" id="star-min-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="star-min-clip-check" onclick="updateUniforms()" checked> 
                        <br>
                        <input type="number" step="0.1" id="star-minval-input" class="number-input minvalinput" name="star-minval"><p class="units star-attr-units"></p>

                        <!-- <input type="number" id="gas-minval-input" class="number-input minvalinput" name="gas-minval" oninput="changeValue('gas','min')"><p class="units gas-attr-units"></p> -->
                    </div>
                    <div id="max">
                        max: <input type="checkbox" id="star-max-check" onclick="updateUniforms()"> clip: <input type="checkbox" id="star-max-clip-check" onclick="updateUniforms()" checked>
                        <br>
                        <!-- <input type="number" id="gas-maxval-input" class="number-input maxvalinput" name="gas-maxval" oninput="changeValue('gas','max')"><p class="units gas-attr-units"></p> -->
                        <input type="number" step="0.1" id="star-maxval-input" class="number-input maxvalinput" name="star-maxval"><p class="units star-attr-units"></p>
                    </div>
                    
                    <div id=star-colorscale>
                        <input type="color" class="color-picker" value="#0000ff" id="starMinCol"><input type="color" class="color-picker"  value="#ff0000" id="starMaxCol">
                        <br>
                    </div> 
                </div>
            
            <!-- <br> -->
            
            <!-- <br> -->
            <!-- <select class="data_select" id="star_select" onchange="requestPoints('PartType4', document.getElementById('star_select').value)"></select>             -->
            <!-- <progress id="star_progress" value="0" max="100"><p>loading</p> </progress> -->
            <!-- <br>
            <br> -->
            <hr>
            <!-- <br> -->

            <label for="bh_select"><h3><img 
                id="bh-eye-open"
                class="eye-icon"
                src="/CosmoVis/assets/eye_open.svg" 
                alt="black holes visible"
                role="button"
                onclick="toggleLayer( 3 )"/>
            <img 
                id="bh-eye-closed"
                class="eye-icon"
                src="/CosmoVis/assets/eye_closed.svg" 
                alt="black holes hidden"
                role="button"
                onclick="toggleLayer( 3 );"/><img 
                id="gas-blend"
                class="blend-icon"
                src="/CosmoVis/assets/blend.svg" 
                alt="blend mode"
                role="button"
                onclick="toggleBlendMode( 5 )"/><div style="display: inline;" onclick="hideDetails('bh')">black holes</div></h3></label>
            
            <br>
            <!-- min: <input type="color" value="#0000ff" id="bhMinCol"> max: <input type="color" value="#ff0000" id="bhMaxCol">
            <br> -->
            <div id="bh-data-details" class="data-details">

                <div id="bh-min">
                min: <input type="checkbox" id="bh-min-check" onclick="toggleValueThreshold('bh','min')"> clip: <input type="checkbox" id="bh-min-clip-check" onclick="clipPoints('bh','min')">
                <br>
                <input type="number" id="bh-minval-input" class="number-input minvalinput" name="bh-minval" oninput="changeValue('bh','min')"><p class="units bh-attr-units"></p>

                </div>
                <div id="bh-max">
                    max: <input type="checkbox" id="bh-max-check" onclick="toggleValueThreshold('bh','max')"> clip: <input type="checkbox" id="bh-max-clip-check" onclick="clipPoints('bh','max')">
                    <br>
                    <input type="number" id="bh-maxval-input" class="number-input maxvalinput" name="bh-maxval" oninput="changeValue('bh','max')"><p class="units bh-attr-units"></p>
                </div>
                
                <div id=bh-colorscale>
                    <input type="color" class="color-picker" value="#0000ff" id="bhMinCol"><input type="color" class="color-picker" value="#ff0000" id="bhMaxCol">
                    <br>
                </div> 


                <select class="data_select" id="bh_select" onchange="requestPoints('PartType5', document.getElementById('bh_select').value, renderCount)"></select>
                
                <!-- sent data: <progress id="bh_progress_sent" value="0" max="100"><p>loading</p> </progress>
                received data: <progress id="bh_progress" value="0" max="100"><p>loading</p> </progress> -->
            </div>
            <hr>

        </div>
        
        <div id="raySelection" class="container">

            <h3><img 
                id="skewer-eye-open"
                class="eye-icon"
                src="/CosmoVis/assets/eye_open.svg" 
                alt="gas visible"
                role="button"
                onclick="toggleLayer( 4 )"/>
            <img 
                id="skewer-eye-closed"
                class="eye-icon"
                src="/CosmoVis/assets/eye_closed.svg" 
                alt="gas hidden"
                role="button"
                onclick="toggleLayer( 4 )"/>
            <img 
                id="skewer-laser"
                class="laser-icon"
                src="/CosmoVis/assets/laser.svg" 
                alt="draw skewer mode"
                role="button"
                onclick="toggleDrawSkewerMode()"/></h3>
            <br>
            <hr>
            <!-- <br> -->

            <div id="skewer-coords">
            </div>


            <!-- <h3>coordinate selection</h3>
            <br>
            <h4>ray origin</h4>
            <p><em>x<sub>1 </sub></em>: <input type="number" class="rayCoordField" id="ray_x1" value="1"> <i>y</i><em><sub>1&nbsp;</sub></em>:<input type="number" class="rayCoordField" id="ray_y1" value="1">  <i>z</i><em><sub>1&nbsp;</sub></em>: <input type="number" class="rayCoordField" id="ray_z1" value="1">&nbsp;</p>
            <h4>ray end</h4>
            <p><em>x<sub>2 </sub></em>: <input type="number" class="rayCoordField" id="ray_x2" value="2"> <i>y</i><em><sub>2&nbsp;</sub></em>:<input type="number" class="rayCoordField" id="ray_y2" value="2">  <i>z</i><em><sub>2&nbsp;</sub></em>: <input type="number" class="rayCoordField" id="ray_z2" value="2">&nbsp;</p>
            <form id="selectRay" method="POST" action="/">
                <input type="submit" value="select ray">
            </form> -->
            <!-- <br> -->
            <!-- <hr> -->
        </div>
        
        <div id="spectrum" class="container">
            <select class="data_select" id="common-wavelengths" onchange="commonWavelength()">
                <option selected disabled>Select a rest wavelength (Å)</option>
                <option value="1215.67"     >HI (1215.67 Å)</option>
                <option value="1548.195"    >C IV (1548.195 Å)</option>
                <option value="1550.77"     >C IV (1550.77 Å)</option>
                <option value="1260.4221"   >Si II (1260.4221 Å)</option>
                <option value="1206.5"      >Si III (1206.5 Å)</option>
                <option value="1334.53"     >C II (1334.53 Å)</option>
            </select>

            <div id="wavelength">
                <input type="radio" id="Angstroms" name="x-axis-transform" value="Angstroms" onchange="commonWavelength()">
                <label for="Angstroms">Wavelength (Å)</label>
                <input type="radio" id="Velocity-Space" name="x-axis-transform" value="Velocity Space" onchange="commonWavelength()">
                <label for="Velocity Space">Velocity Space (km/s)</label>
            </div>


            <button type="submit" class="request-button" onclick="window.open('data/spectra.fits')"  >download spectra</button>
        </div>
        <!-- <img 
            class="icon"
            src="/assets/wrench.svg" 
            alt="control panel"
            role="button"
            onclick="gui()"/>
        <div id="my-gui-container" class="container">

        </div> -->
        
        <div id="terminal" class="container">
            <div id="gas-density-mod" class="density-mod">
                <p><input type="checkbox" id="density-mod-check" onclick="updateUniforms()" checked> density opacity modulation</p>
                <p><input type="checkbox" id="grayscale-mod-check" onclick="updateUniforms()" checked> grayscale depth filter</p>
                <p><input type="checkbox" id="dither-check" onclick="updateUniforms()"> dither</p>
                <p><input type="range" id="step-size" min="0.1" max="4.0" step="0.1" value="1.0" onchange="updateUniforms()"> step size</p>
                <p><select class="data_select" id="size_select" onchange="updateSize()">
                    <option selected="selected" disabled="disabled">Select voxel grid size (n&sup3;)</option>
                    <option value="64">64&sup3;</option>
                    <option value="128">128&sup3;</option>
                    <option value="256">256&sup3;</option>
                </select></p>
            </div>
        </div>
    </div>
    
    <div hidden class="sidebar">
        <!-- <h1>cosmovis</h1> -->
        <nav>
            


            
            <!--         
            <h2>particles</h2>
            <ul>
                <li>gas</li>
                <li>dark matter</li>
                <li>stars</li>
                <li>black holes</li>
            </ul> -->
        </nav>
    </div>

    
    
    <!-- <h2>Receive:</h2>
    <div id="log"></div> -->
    <script>
    namespace = '/test';
    var socket = io(namespace, {reconnect: true});
    </script>
    </body>

    <footer hidden><div>Refresh icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> Delete icon made by <a href="https://www.flaticon.com/authors/kiranshastry" title="Kiranshastry">Kiranshastry</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> Laser icon made by  <a href="https://www.flaticon.com/authors/those-icons" title="Those Icons">Those Icons</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>, Eye icon made by <a href="https://www.flaticon.com/authors/kiranshastry" title="Kiranshastry">Kiranshastry</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>, Eye icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>, Layer icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>Telescope icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>,<a href="https://www.flaticon.com/authors/dinosoftlabs" title="DinosoftLabs">DinosoftLabs</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>, Line Graph Icon made by Zach Bogart from the Noun Project, Wrench Icon by Icon Lauk from the Noun Project</div></footer>

</html>